<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Orbit Control Center</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @keyframes pulse-custom {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .animate-pulse-custom {
        animation: pulse-custom 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      .sortable {
        cursor: pointer;
        user-select: none;
      }
      .sortable:hover {
        background-color: rgba(55, 65, 81, 0.5);
      }
    </style>
    <script>
      let projectsData = [];
      let sortColumn = null;
      let sortDirection = "asc";

      async function loadDashboard() {
        try {
          const resp = await fetch("/api/dashboard");
          const data = await resp.json();

          // Update System Health
          const loadEl = document.getElementById("system-load");
          loadEl.innerText = data.load.toFixed(2);
          if (data.overloaded) {
            loadEl.className = "text-3xl font-bold text-red-500";
          } else {
            loadEl.className = "text-3xl font-bold text-green-500";
          }

          // Store projects data
          projectsData = data.projects;
          renderProjects();
        } catch (err) {
          console.error("Failed to load dashboard", err);
        }
      }

      function renderProjects() {
        const tbody = document.getElementById("projects-body");
        tbody.innerHTML = "";

        let projects = [...projectsData];

        // Apply sorting
        if (sortColumn) {
          projects.sort((a, b) => {
            let valA, valB;
            if (sortColumn === "name") {
              valA = a.name.toLowerCase();
              valB = b.name.toLowerCase();
            } else if (sortColumn === "status") {
              valA = a.status.toLowerCase();
              valB = b.status.toLowerCase();
            } else if (sortColumn === "result") {
              valA = a.last_result.toLowerCase();
              valB = b.last_result.toLowerCase();
            } else if (sortColumn === "time") {
              valA = a.time_ago;
              valB = b.time_ago;
            }

            if (valA < valB) return sortDirection === "asc" ? -1 : 1;
            if (valA > valB) return sortDirection === "asc" ? 1 : -1;
            return 0;
          });
        }

        projects.forEach((proj) => {
          let statusBadge = `<span class="text-gray-300">${proj.status}</span>`;
          if (proj.state_class === "building") {
            statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-900 text-yellow-200 animate-pulse-custom">${proj.status}</span>`;
          } else if (proj.state_class === "idle") {
            statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-700 text-gray-300">${proj.status}</span>`;
          }

          let resultText = '<span class="text-gray-500">N/A</span>';
          if (proj.result_class === "success") {
            resultText =
              '<span class="text-green-400 font-semibold">Success</span>';
          } else if (proj.result_class === "failed") {
            resultText =
              '<span class="text-red-400 font-semibold">Rollback</span>';
          }

          const row = `
            <tr class="hover:bg-gray-750 transition-colors border-b border-gray-700 last:border-0">
                <td class="px-6 py-4 font-medium text-white">${proj.name}</td>
                <td class="px-6 py-4">${statusBadge}</td>
                <td class="px-6 py-4">${resultText}</td>
                <td class="px-6 py-4 text-gray-400 font-mono text-sm">${proj.time_ago}</td>
                <td class="px-6 py-4">
                    <button onclick="triggerBuild('${proj.name}')" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-3 rounded shadow hover:shadow-md transition-all active:scale-95">
                        üöÄ Build
                    </button>
                </td>
            </tr>
            `;
          tbody.insertAdjacentHTML("beforeend", row);
        });
      }

      function sortBy(column) {
        if (sortColumn === column) {
          sortDirection = sortDirection === "asc" ? "desc" : "asc";
        } else {
          sortColumn = column;
          sortDirection = "asc";
        }

        // Update header indicators
        document
          .querySelectorAll(".sort-indicator")
          .forEach((el) => el.remove());
        const header = document.querySelector(`[data-sort="${column}"]`);
        const indicator = sortDirection === "asc" ? " ‚ñ≤" : " ‚ñº";
        header.innerHTML =
          header.innerHTML.split(" ‚ñ≤")[0].split(" ‚ñº")[0] +
          `<span class="sort-indicator">${indicator}</span>`;

        renderProjects();
      }

      async function triggerBuild(projectName) {
        try {
          const resp = await fetch(`/api/build?project=${projectName}`, {
            method: "POST",
          });
          if (resp.ok) {
            loadDashboard(); // Refresh immediately
          } else {
            alert("Failed to trigger build");
          }
        } catch (e) {
          alert("Error triggering build");
        }
      }

      // Poll every 2 seconds
      setInterval(loadDashboard, 2000);
      window.onload = loadDashboard;
    </script>
  </head>
  <body class="bg-gray-900 text-gray-300 font-mono antialiased p-6">
    <div class="max-w-7xl mx-auto">
      <header
        class="flex justify-between items-center border-b border-gray-700 pb-4 mb-8"
      >
        <h1 class="text-3xl text-blue-400 font-bold tracking-tight">
          üî≠ Orbit Control Center
        </h1>
        <a
          href="/config"
          class="text-sm bg-gray-800 hover:bg-gray-700 text-blue-400 px-3 py-1 rounded border border-gray-700 transition-colors"
        >
          ‚öôÔ∏è Config
        </a>
      </header>

      <!-- System Health -->
      <div
        class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-8 shadow-lg"
      >
        <h3 class="text-xl font-semibold text-gray-100 mb-4">System Health</h3>
        <div class="flex items-center space-x-4">
          <span class="text-gray-400">Load Average:</span>
          <span id="system-load" class="text-3xl font-bold text-gray-500"
            >...</span
          >
        </div>
      </div>

      <!-- Mission Status -->
      <div
        class="bg-gray-800 border border-gray-700 rounded-lg shadow-lg overflow-hidden"
      >
        <div class="p-6 border-b border-gray-700">
          <h3 class="text-xl font-semibold text-gray-100">Mission Status</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead class="bg-gray-800 text-gray-400 uppercase text-xs">
              <tr>
                <th
                  class="px-6 py-3 sortable"
                  data-sort="name"
                  onclick="sortBy('name')"
                >
                  Project
                </th>
                <th
                  class="px-6 py-3 sortable"
                  data-sort="status"
                  onclick="sortBy('status')"
                >
                  Current State
                </th>
                <th
                  class="px-6 py-3 sortable"
                  data-sort="result"
                  onclick="sortBy('result')"
                >
                  Last Result
                </th>
                <th
                  class="px-6 py-3 sortable"
                  data-sort="time"
                  onclick="sortBy('time')"
                >
                  Last Run
                </th>
                <th class="px-6 py-3">Action</th>
              </tr>
            </thead>
            <tbody id="projects-body" class="divide-y divide-gray-700">
              <!-- JS populated -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </body>
</html>
